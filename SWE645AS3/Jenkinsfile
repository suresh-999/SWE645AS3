// Group Members:
//  Suresh Ande  (G01381683)
//  Chandrashakar Gudipally (G01410349)
//  Abhishek Darana ( G01408181) 
//  Anjan kumar sripati panditaradhyula (G01407403)

// demo


pipeline {
    agent any
    environment {
        DOCKERHUB_PASS = credentials('dockerhubcred')
        DOCKER_TAG = "latest"
        def dateTag = new Date().format("yyyyMMdd-HHmmss")
    }
    stages {
              stage('Checkout code') {
            steps {
                checkout scm
            }
        }

        stage('Build JAR') {
            steps {
               dir('SWE645AS3') {
                sh 'mvn clean package -DskipTests'
               }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    docker.withRegistry('', DOCKER_CRED_ID) {
                        def app = docker.build("${DOCKER_REGISTRY}/${IMAGE_REPO}:${IMAGE_TAG}", '-f Dockerfile .')
                    }
                }
            }
        }

        stage('Push to DockerHub') {
            steps {
                script {
                    docker.withRegistry('', DOCKER_CRED_ID) {
                        def app = docker.image("${DOCKER_REGISTRY}/${IMAGE_REPO}:${IMAGE_TAG}")
                        app.push()
                    }
                }
            }
        }
        stage("Deploying to Rancher as single pod") {
            steps {                                  
                  sh 'kubectl set image deployment/studentsurvey-pipeline container-0=suresh999/swe645as3:${dateTag} -n default'         
            }
        }
        stage("Deploying to Rancher with load balancer") {
            steps { 
                sh 'kubectl set image deployment/studentsurvey-lb container-0=suresh999/swe645as3:${dateTag} -n default'
            }
        }
    }
}
